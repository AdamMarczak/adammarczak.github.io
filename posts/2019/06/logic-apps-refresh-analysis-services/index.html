<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns#" lang="en-us">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Refreshing Azure Analysis Services models using Logic Apps | Adam Marczak | Marczak.IO</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="icon" type="image/png" href="https://marczak.io/images/favicon-32x32.png" sizes="32x32" />
<link rel="icon" type="image/png" href="https://marczak.io/images/favicon-16x16.png" sizes="16x16" />
<link rel="apple-touch-icon-precomposed" href="https://marczak.io/images/iphone-icon.png"/>
<link rel="stylesheet" id="hestia_fonts-css" href="https://fonts.googleapis.com/css?family=Roboto%3A300%2C400%2C500%2C700%7CRoboto+Slab%3A400%2C700&amp;subset=latin%2Clatin-ext" type="text/css" media="all">
<link rel="stylesheet" id="bootstrap-css" href="https://netdna.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" type="text/css" media="all">
<link rel="stylesheet" id="font-awesome-css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" type="text/css" media="all">
<link href='https://marczak.io/css/hestia.min.css' rel="stylesheet" type="text/css" />
<link href='https://marczak.io/css/main.min.css?ver=1.16' rel='stylesheet' type="text/css" />

<meta name="description" content="In 2017 asynchronous refresh API was released for Azure Analysis Services which allows users to refresh their models with simple REST calls. This allows for easy integration with their orchestration solutions. Learn how to build very simple logic apps and manage Azure Analysis Services refresh schedule.">
<meta name="author" content="Adam Marczak">
<meta name="copyright" content="Adam Marczak">
<meta name="title" content="Refreshing Azure Analysis Services models using Logic Apps | Adam Marczak | Marczak.IO">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="https://www.facebook.com/MarczakIO/">
<meta property="og:type" content="article">
<meta property="og:title" content="Refreshing Azure Analysis Services models using Logic Apps">
<meta property="og:description" content="In 2017 asynchronous refresh API was released for Azure Analysis Services which allows users to refresh their models with simple REST calls. This allows for easy integration with their orchestration solutions. Learn how to build very simple logic apps and manage Azure Analysis Services refresh schedule.">
<meta property="og:url" content="https://marczak.io/posts/2019/06/logic-apps-refresh-analysis-services/">
<meta property="og:site_name" content="Marczak.IO">
<meta property="og:image" content="https://marczak.io/images/logic-apps-refresh-analysis-services/splash.png">

<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@MarczakIO">
<meta name="twitter:title" content="Refreshing Azure Analysis Services models using Logic Apps">
<meta name="twitter:description" content="In 2017 asynchronous refresh API was released for Azure Analysis Services which allows users to refresh their models with simple REST calls. This allows for easy integration with their orchestration solutions. Learn how to build very simple logic apps and manage Azure Analysis Services refresh schedule.">
<meta name="twitter:url" content="https://marczak.io/posts/2019/06/logic-apps-refresh-analysis-services/">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-106560028-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments)};
  gtag('js', new Date());

  gtag('config', 'UA-106560028-1');
</script>
</head>
<body class="home blog">
  <div class="wrapper"><header class="header ">
  <nav class="navbar navbar-default navbar-fixed-top  hestia_left">
    <div class="container">
      <div class="navbar-header">
        <div class="title-logo-wrapper">
          <a class="navbar-brand" href="/" title="Marczak.IO">
            <p>Adam Marczak</p>
          </a>
        </div>
        
      </div>
      <div id="main-navigation" class="collapse navbar-collapse">
        <div class="entry-social">
  <a target="_top" class="btn btn-just-icon btn-social btn-social-mail"
     href="mailto:adam@marczak.io">
    <i class="fa fa-envelope-o"></i>
  </a>
  <a target="_blank" class="btn btn-just-icon btn-social btn-social-facebook"
     href="https://www.facebook.com/MarczakIO/">
    <i class="fa fa-facebook"></i>
  </a>
  <a target="_blank" class="btn btn-just-icon btn-social btn-social-twitter"
     href="https://twitter.com/MarczakIO">
    <i class="fa fa-twitter"></i>
  </a>
  <a target="_blank" class="btn btn-just-icon btn-social btn-social-linkedin"
     href="https://www.linkedin.com/in/adam-marczak-96088929/">
    <i class="fa fa-linkedin"></i>
  </a>
  <a target="_blank" class="btn btn-just-icon btn-social btn-social-youtube"
     href="https://www.youtube.com/channel/UCbbjOn2UosI_yaD5d4w_Flw">
    <i class="fa fa-youtube"></i>
  </a>
</div>
      </div>
      
    </div>
  </nav>
  <div id="primary" class="boxed-layout-header page-header header-small" data-parallax="active" style="margin-top: 50px;">
    <div class="container" style="padding-top: 150px;">
      <div class="row">
        <div class="col-md-10 col-md-offset-1 text-center">
          <h1 class="hestia-title">Refreshing Azure Analysis Services models using Logic Apps</h1>
          
            <h4 class="author">
              Published by 
              <a href="/about" title="Adam Marczak" class="vcard author"><strong class="fn">Adam Marczak</strong></a>
              </a> on 
              <time class="date updated published" datetime="2019-06-15 11:00:23 &#43;0200 CEST">
                  Jun 15 2019
              </time>
            </h4>
           
        </div>
      </div>
    </div>
    <div class="header-filter" 
         style="background-image: url('/images/background.jpg');background-color: #283743;">
    </div>

  </div>
</header>
    <div class="main main-raised">
      <div class="hestia-blogs">
        <div class="container">
          <div class="row">
<div class="col-md-9 single-posts-wrap">
    <article id="/posts/2019/06/logic-apps-refresh-analysis-services/" class="article-section section-text"> 
<div class="lazy" style="max-height: 1080px">
    <div style="padding-bottom:56.36743215031315%"></div>
    <img data-src="/images/logic-apps-refresh-analysis-services/splash.png" src=""/> 
</div> <a target="_blank" 
   rel="tooltip" 
   class="btn btn-github"
   href="https://github.com/MarczakIO/aas-refresh-logic-apps">
    <i class="fa fa-github"></i>
    Source Code
</a>
        <h2>Highlight</h2>
        <p>In 2017 asynchronous refresh API was released for Azure Analysis Services which allows users to refresh their models with simple REST calls. This allows for easy integration with their orchestration solutions. Learn how to build very simple logic apps and manage Azure Analysis Services refresh schedule.</p>

<h2 id="intro">Intro</h2>

<p>Azure Analysis Services is a great in-memory analytical engine which allows enterprises to build very scalable and fast reporting solutions. In recent years Microsoft decided to provide this solution as Platform as a Service, bringing Azure Analysis Services. One of the key challenges in the cloud was refreshing analytical models which in the past was achieved using PowerShell scripts.</p>

<p>With release of refresh and sync API&rsquo;s this process can be automated with variety of tools and services. In this article, a very simple Logic App will be created which will schedule model refresh and wait for its ending. This will present a classic principle of orchestration which then can be further integrated with other services.</p>

<h3 id="prerequisites">Prerequisites</h3>

<p>In order to execute this scenario a developer must have following tools</p>

<ol>
<li>Azure Subscription</li>
<li>Azure Analysis Services with any model deployed</li>
<li><a href="https://docs.microsoft.com/en-us/sql/ssms/download-sql-server-management-studio-ssms?view=sql-server-2017">SQL Server Management Studio 2017+</a></li>
</ol>

<h2 id="design">Design</h2>

<p>In this article Azure Analysis Services REST API will be used. This second covers high level principles on how this process should be done.</p>

<p>In high level Azure Analysis Services API looks as follows
 
<div class="lazy" style="max-height: 155px">
    <div style="padding-bottom:17.51412429378531%"></div>
    <img data-src="/images/logic-apps-refresh-analysis-services/aas-async-refresh-flow.png" src=""/> 
</div>  </p>

<h3 id="refreshing-model-with-post-refreshes">Refreshing model with POST /refreshes</h3>

<p>In order to refresh model on analysis services a REST call must be performed on
https://<strong>&lt;rollout&gt;</strong>.asazure.windows.net/servers/<strong>&lt;serverName&gt;</strong>/models/<strong>&lt;resource&gt;</strong>/refresh</p>

<p>As per diagram
 
<div class="lazy" style="max-height: 155px">
    <div style="padding-bottom:17.51412429378531%"></div>
    <img data-src="/images/logic-apps-refresh-analysis-services/aas-async-refresh-flow-post.png" src=""/> 
</div>  </p>

<ul>
<li><strong>&lt;rollout&gt;</strong> region name where analysis services is deployed. This can be retrieved from analysis services URL.</li>
<li><strong>&lt;serverName&gt;</strong> name of azure resource, this is also unique public DNS name for analysis services.</li>
<li><strong>&lt;resource&gt;</strong> name of analysis services model deployed on the server.</li>
</ul>

<h4 id="request">Request</h4>

<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="nt">&#34;Type&#34;</span><span class="p">:</span> <span class="s2">&#34;Full&#34;</span><span class="p">,</span>
  <span class="nt">&#34;CommitMode&#34;</span><span class="p">:</span> <span class="s2">&#34;transactional&#34;</span><span class="p">,</span>
  <span class="nt">&#34;MaxParallelism&#34;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
  <span class="nt">&#34;RetryCount&#34;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
  <span class="nt">&#34;Objects&#34;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="nt">&#34;table&#34;</span><span class="p">:</span> <span class="s2">&#34;DimCustomer&#34;</span><span class="p">,</span>
        <span class="nt">&#34;partition&#34;</span><span class="p">:</span> <span class="s2">&#34;DimCustomer&#34;</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="nt">&#34;table&#34;</span><span class="p">:</span> <span class="s2">&#34;DimDate&#34;</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span></code></pre></div>

<ul>
<li><strong>Type</strong> a <a href="https://docs.microsoft.com/en-us/bi-reference/tmsl/refresh-command-tmsl">TMSL refresh type</a>. Accepted options are: full, clearValues, calculate, dataOnly, automatic, add, defragment.</li>
<li><strong>CommitMode</strong> is defining if objects during refresh will be committed in batches or only when completed. Currently only three options are valid: default, transactional, partialBatch.</li>
<li><strong>MaxParallelism</strong> how many parallel threads are processing the model. Must be within MaxParallelism setting of the server.</li>
<li><strong>RetryCount</strong> how many times server retries operation before failing.</li>
<li><strong>Objects</strong> array of objects to refresh. Tables or partitions are accepted. No objects on the list means entire model.</li>
</ul>

<p>For more info check the documentation <a href="https://docs.microsoft.com/en-us/azure/analysis-services/analysis-services-async-refresh">HERE</a>.</p>

<h4 id="response-202-accepted">Response (202 Accepted)</h4>

<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="err">Empty</span></code></pre></div>

<p>But there is very important header in the response. This header can be used to check status in following requests.
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="nt">&#34;Location&#34;</span><span class="p">:</span> <span class="s2">&#34;https://&lt;rollout&gt;.asazure.windows.net/servers/&lt;serverName&gt;/models/&lt;resource&gt;/refreshes/&lt;refreshId&gt;&#34;</span>
<span class="p">}</span></code></pre></div></p>

<h4 id="response-409-conflict">Response (409 Conflict)</h4>

<p>If there is already model refresh currently running request response with 409 code will be returned. This means in production environment a model refresh submission should be wrapped in the loop trying to submit refresh until no 409 is returned.
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="nt">&#34;code&#34;</span><span class="p">:</span> <span class="s2">&#34;Conflict&#34;</span><span class="p">,</span>
  <span class="nt">&#34;subCode&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="nt">&#34;message&#34;</span><span class="p">:</span> <span class="s2">&#34;Refresh job could not be created since there is already an active job running for model &#39;&lt;resource&gt;&#39;&#34;</span><span class="p">,</span>
  <span class="nt">&#34;timeStamp&#34;</span><span class="p">:</span> <span class="s2">&#34;2019-06-16T22:15:37.7356458Z&#34;</span><span class="p">,</span>
  <span class="nt">&#34;httpStatusCode&#34;</span><span class="p">:</span> <span class="mi">409</span><span class="p">,</span>
  <span class="nt">&#34;details&#34;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nt">&#34;code&#34;</span><span class="p">:</span> <span class="s2">&#34;RootActivityId&#34;</span><span class="p">,</span>
      <span class="nt">&#34;message&#34;</span><span class="p">:</span> <span class="s2">&#34;e5103f37-def2-43b0-b974-9169c3acd91d&#34;</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="nt">&#34;code&#34;</span><span class="p">:</span> <span class="s2">&#34;Param1&#34;</span><span class="p">,</span>
      <span class="nt">&#34;message&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;resource&gt;&#34;</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span></code></pre></div></p>

<h3 id="checking-refresh-status-with-get-refreshes-refresh-id">Checking refresh status with GET /refreshes&lt;refresh_id&gt;</h3>

<p>To get status of refresh a REST call must be performed on
https://<strong>&lt;rollout&gt;</strong>.asazure.windows.net/servers/<strong>&lt;serverName&gt;</strong>/models/<strong>&lt;resource&gt;</strong>/refreshes/<strong>&lt;refreshId&gt;</strong>
 
<div class="lazy" style="max-height: 155px">
    <div style="padding-bottom:17.51412429378531%"></div>
    <img data-src="/images/logic-apps-refresh-analysis-services/aas-async-refresh-flow-get.png" src=""/> 
</div>  </p>

<ul>
<li><strong>&lt;rollout&gt;</strong> region name where analysis services is deployed. This can be retrieved from analysis services URL.</li>
<li><strong>&lt;serverName&gt;</strong> name of azure resource, this is also unique public DNS name for analysis services.</li>
<li><strong>&lt;resource&gt;</strong> name of analysis services model deployed on the server.</li>
<li><strong>&lt;refreshId&gt;</strong> name of analysis services model deployed on the server.</li>
</ul>

<h4 id="request-1">Request</h4>

<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="err">Empty</span> <span class="err">because</span> <span class="err">it&#39;s</span> <span class="err">GET</span></code></pre></div>

<h4 id="response-200-ok">Response (200 OK)</h4>

<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="p">{</span>
  <span class="nt">&#34;startTime&#34;</span><span class="p">:</span> <span class="s2">&#34;2019-06-16T22:24:06.9112816Z&#34;</span><span class="p">,</span>
  <span class="nt">&#34;endTime&#34;</span><span class="p">:</span> <span class="s2">&#34;2019-06-16T22:24:08.2919036Z&#34;</span><span class="p">,</span>
  <span class="nt">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;full&#34;</span><span class="p">,</span>
  <span class="nt">&#34;status&#34;</span><span class="p">:</span> <span class="s2">&#34;succeeded&#34;</span><span class="p">,</span>
  <span class="nt">&#34;currentRefreshType&#34;</span><span class="p">:</span> <span class="s2">&#34;full&#34;</span><span class="p">,</span>
  <span class="nt">&#34;objects&#34;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="nt">&#34;table&#34;</span><span class="p">:</span> <span class="s2">&#34;&lt;table_name&gt;&#34;</span><span class="p">,</span>
      <span class="nt">&#34;partition&#34;</span><span class="p">:</span> <span class="s2">&#34;Partition&#34;</span><span class="p">,</span>
      <span class="nt">&#34;status&#34;</span><span class="p">:</span> <span class="s2">&#34;succeeded&#34;</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span></code></pre></div>

<p>Available statuses are</p>

<ul>
<li>notStarted</li>
<li>inProgress</li>
<li>failed</li>
<li>succeeded</li>
</ul>

<p>Which means process should check for either <strong>failed</strong> or <strong>succeeded</strong>. All responses are returned with 200 http status call.</p>

<h3 id="authentication">Authentication</h3>

<p>All calls must be authenticated with a valid Azure Active Directory (OAuth 2) token in the Authorization header and must meet the following requirements:</p>

<ul>
<li>Only user or service principal tokens are accepted. It would appear that Managed Identity tokens are not accepted at the time of writing.</li>
<li>Audience of the token must be set to https://*.asazure.windows.net.</li>
<li>User or service principal must have AAS administrator privileges.</li>
</ul>

<h2 id="provisioning">Provisioning</h2>

<p>Log into <a href="https://portal.azure.com">Azure Portal</a> and start creating resources.</p>

<hr />

<h3 id="span-style-color-1c87d6-hint-span"><span style="color:#1c87d6">Hint</span></h3>

<p>This can be automated quickly using ARM template that I created for this. Template can be found below.</p>

<p><a href="https://github.com/MarczakIO/aas-refresh-logic-apps/blob/master/logic-app.json">logic-apps-arm.json</a></p>

<hr />

<p>Check Application Account and Privilege setup sections to find out proper values for this template.</p>

<h3 id="resource-group">Resource Group</h3>

<ol>
<li>Click on &ldquo;+&rdquo; sign to create new resource

<div class="lazy" style="max-height: 98px">
    <div style="padding-bottom:29.34131736526946%"></div>
    <img data-src="/images/logic-apps-refresh-analysis-services/1.png" src=""/> 
</div>  </li>
<li>Type in logic app** in Search window and press enter

<div class="lazy" style="max-height: 213px">
    <div style="padding-bottom:43.46938775510204%"></div>
    <img data-src="/images/logic-apps-refresh-analysis-services/2.png" src=""/> 
</div>  </li>
<li>Click Create button

<div class="lazy" style="max-height: 178px">
    <div style="padding-bottom:41.58878504672897%"></div>
    <img data-src="/images/logic-apps-refresh-analysis-services/23.png" src=""/> 
</div>  </li>
<li>Fill in basic info, name and location

<div class="lazy" style="max-height: 510px">
    <div style="padding-bottom:149.12280701754386%"></div>
    <img data-src="/images/logic-apps-refresh-analysis-services/3.png" src=""/> 
</div>  </li>
</ol>

<h2 id="application-account">Application Account</h2>

<p>Log into <a href="https://portal.azure.com">Azure Portal</a> and start creating resources.</p>

<ol>
<li>Go to <strong>Azure Active Directory</strong> into <strong>App registrations</strong>

<div class="lazy" style="max-height: 546px">
    <div style="padding-bottom:105.60928433268859%"></div>
    <img data-src="/images/logic-apps-refresh-analysis-services/24.png" src=""/> 
</div>  </li>
<li>Click on <strong>New registration</strong>

<div class="lazy" style="max-height: 389px">
    <div style="padding-bottom:58.58433734939759%"></div>
    <img data-src="/images/logic-apps-refresh-analysis-services/37.png" src=""/> 
</div>  </li>
<li>Name app, leave everything as default

<div class="lazy" style="max-height: 775px">
    <div style="padding-bottom:100.12919896640827%"></div>
    <img data-src="/images/logic-apps-refresh-analysis-services/8.png" src=""/> 
</div>  </li>
<li>Copy Application (Client) ID, this will be required for later steps

<div class="lazy" style="max-height: 276px">
    <div style="padding-bottom:29.39297124600639%"></div>
    <img data-src="/images/logic-apps-refresh-analysis-services/29.png" src=""/> 
</div>  </li>
<li>Click on <strong>Certificates &amp; secrets</strong>

<div class="lazy" style="max-height: 489px">
    <div style="padding-bottom:50.62111801242236%"></div>
    <img data-src="/images/logic-apps-refresh-analysis-services/32.png" src=""/> 
</div>  </li>
<li>Click on <strong>New Client secret</strong>

<div class="lazy" style="max-height: 359px">
    <div style="padding-bottom:124.65277777777777%"></div>
    <img data-src="/images/logic-apps-refresh-analysis-services/33.png" src=""/> 
</div>  </li>
<li>Give it a name and expiration date and then select <strong>add</strong>

<div class="lazy" style="max-height: 542px">
    <div style="padding-bottom:61.10484780157835%"></div>
    <img data-src="/images/logic-apps-refresh-analysis-services/10.png" src=""/> 
</div>  </li>
<li>Go to newly generated key and copy the value, this will be required for later steps

<div class="lazy" style="max-height: 538px">
    <div style="padding-bottom:84.7244094488189%"></div>
    <img data-src="/images/logic-apps-refresh-analysis-services/34.png" src=""/> 
</div>  </li>
<li>Go to <strong>Azure Active Directory</strong> into <strong>Properties</strong></li>
<li>Copy <strong>Directory ID</strong>, this will be required for later steps

<div class="lazy" style="max-height: 625px">
    <div style="padding-bottom:90.57971014492753%"></div>
    <img data-src="/images/logic-apps-refresh-analysis-services/31.png" src=""/> 
</div>  </li>
</ol>

<p>For further steps three properties are required</p>

<ul>
<li>Directory ID</li>
<li>Application (Client) ID</li>
<li>Key (Secret)</li>
</ul>

<h2 id="privilege-setup">Privilege setup</h2>

<ol>
<li>Open SQL Server Management Studio</li>
<li>Connect to Analysis Services

<div class="lazy" style="max-height: 315px">
    <div style="padding-bottom:66.0377358490566%"></div>
    <img data-src="/images/logic-apps-refresh-analysis-services/9.png" src=""/> 
</div>  </li>
<li>Right-click on server and select <strong>Properties</strong>

<div class="lazy" style="max-height: 371px">
    <div style="padding-bottom:102.48618784530387%"></div>
    <img data-src="/images/logic-apps-refresh-analysis-services/25.png" src=""/> 
</div>  </li>
<li>Go to <strong>Security</strong> page and click <strong>Add</strong> button

<div class="lazy" style="max-height: 422px">
    <div style="padding-bottom:38.71559633027523%"></div>
    <img data-src="/images/logic-apps-refresh-analysis-services/30.png" src=""/> 
</div>  </li>
<li>Search for app by name given in previous step or add manual entry in following convention

<div class="lazy" style="max-height: 491px">
    <div style="padding-bottom:127.86458333333333%"></div>
    <img data-src="/images/logic-apps-refresh-analysis-services/39.png" src=""/> 
</div>  
Convention IS
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text"> app:&lt;application_id&gt;@&lt;tenant_id&gt;
 </code></pre></div>
In this example this would mean value
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text"> app:df1b8569-352d-4be0-acf3-847a2e72aee0@564006af-8627-42d3-b8a6-30a1f1e69fab
 </code></pre></div></li>
<li>Click <strong>Add</strong>

<div class="lazy" style="max-height: 179px">
    <div style="padding-bottom:25.979680696661827%"></div>
    <img data-src="/images/logic-apps-refresh-analysis-services/38.png" src=""/> 
</div>  </li>
</ol>

<h2 id="build-logic-app">Build Logic App</h2>

<ol>
<li>Open Logic App and navigate to <strong>Designer</strong></li>
<li>Click on <strong>Blank Logic App</strong> block in the designer window

<div class="lazy" style="max-height: 293px">
    <div style="padding-bottom:100.34246575342466%"></div>
    <img data-src="/images/logic-apps-refresh-analysis-services/4.png" src=""/> 
</div>  </li>
<li>Search for <strong>schedule</strong> trigger

<div class="lazy" style="max-height: 299px">
    <div style="padding-bottom:45.303030303030305%"></div>
    <img data-src="/images/logic-apps-refresh-analysis-services/26.png" src=""/> 
</div>  </li>
<li>And select for <strong>recurrence action</strong>

<div class="lazy" style="max-height: 152px">
    <div style="padding-bottom:22.92609351432881%"></div>
    <img data-src="/images/logic-apps-refresh-analysis-services/5.png" src=""/> 
</div>  </li>
<li>Add new step

<div class="lazy" style="max-height: 39px">
    <div style="padding-bottom:29.545454545454547%"></div>
    <img data-src="/images/logic-apps-refresh-analysis-services/6.png" src=""/> 
</div>  </li>
<li>Search for <strong>HTTP</strong> action

<div class="lazy" style="max-height: 290px">
    <div style="padding-bottom:43.80664652567976%"></div>
    <img data-src="/images/logic-apps-refresh-analysis-services/7.png" src=""/> 
</div>  </li>
<li>Configure HTTP call as follows

<div class="lazy" style="max-height: 702px">
    <div style="padding-bottom:105.72289156626506%"></div>
    <img data-src="/images/logic-apps-refresh-analysis-services/11.png" src=""/> 
</div>  

<ul>
<li><strong>Method</strong> - submitting new refresh schedules are always done with <strong>POST</strong> calls</li>
<li><strong>URI</strong> is built as https://<strong>&lt;rollout&gt;</strong>.asazure.windows.net/servers/<strong>&lt;serverName&gt;</strong>/models/<strong>&lt;resource&gt;</strong>/refresh

<div class="lazy" style="max-height: 155px">
    <div style="padding-bottom:17.51412429378531%"></div>
    <img data-src="/images/logic-apps-refresh-analysis-services/aas-async-refresh-flow-post.png" src=""/> 
</div>  
In this example the URL would be, <strong>rollout</strong> - region name, <strong>northeurope</strong>, <strong>servername</strong> - analysis services instance name, <strong>marczakioaas</strong>, <strong>resource</strong> - analysis services model name, <strong>aas-refresh-model</strong>

<div class="lazy" style="max-height: 381px">
    <div style="padding-bottom:36.49425287356322%"></div>
    <img data-src="/images/logic-apps-refresh-analysis-services/28.png" src=""/> 
</div>  </li>
<li><strong>Headers</strong> - only header required is <strong>Content-Type</strong> with <strong>application/json</strong> value since a JSON configuration will be sent over</li>
<li><strong>Body</strong> - Send over request details. For full refresh send below request.
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"> <span class="p">{</span>
  <span class="nt">&#34;CommitMode&#34;</span><span class="p">:</span> <span class="s2">&#34;transactional&#34;</span><span class="p">,</span>
  <span class="nt">&#34;MaxParallelism&#34;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
  <span class="nt">&#34;Objects&#34;</span><span class="p">:</span> <span class="p">[],</span>
  <span class="nt">&#34;RetryCount&#34;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
  <span class="nt">&#34;Type&#34;</span><span class="p">:</span> <span class="s2">&#34;Full&#34;</span>
<span class="p">}</span></code></pre></div>
It is also possible to refresh model partially. In this case in the <strong>Objects</strong> property send list of tables or partitions to refresh.</li>
<li><strong>Authentication</strong> - Authenticate to Analysis Services using previously created application. Pass previously saved values and add <strong>https://*.asazure.windows.net</strong> URL as <strong>Audience</strong>.</li>
</ul></li>
<li>Click on three dots on current HTTP call step and select <strong>Settings</strong>

<div class="lazy" style="max-height: 536px">
    <div style="padding-bottom:54.91803278688525%"></div>
    <img data-src="/images/logic-apps-refresh-analysis-services/35.png" src=""/> 
</div>  
2.Find <strong>Asynchronous Pattern</strong> option

<div class="lazy" style="max-height: 251px">
    <div style="padding-bottom:29.050925925925927%"></div>
    <img data-src="/images/logic-apps-refresh-analysis-services/36.png" src=""/> 
</div>  
2.Unselect <strong>Asynchronous Pattern</strong>

<div class="lazy" style="max-height: 106px">
    <div style="padding-bottom:16.85214626391097%"></div>
    <img data-src="/images/logic-apps-refresh-analysis-services/12.png" src=""/> 
</div>  </li>
<li>Add new step

<div class="lazy" style="max-height: 39px">
    <div style="padding-bottom:29.545454545454547%"></div>
    <img data-src="/images/logic-apps-refresh-analysis-services/6.png" src=""/> 
</div>  </li>
<li>Search for <strong>Variables</strong> and add new <strong>Initialize Variable</strong> step. This variable will be used in loop iteration to check for refresh status.

<div class="lazy" style="max-height: 271px">
    <div style="padding-bottom:40.93655589123867%"></div>
    <img data-src="/images/logic-apps-refresh-analysis-services/16.png" src=""/> 
</div>  

<ul>
<li><strong>Name</strong> - call it <strong>refreshStatus</strong></li>
<li><strong>Type</strong> - make it <strong>string</strong></li>
<li><strong>value</strong> - leave this empty</li>
</ul></li>
<li>Add new step

<div class="lazy" style="max-height: 39px">
    <div style="padding-bottom:29.545454545454547%"></div>
    <img data-src="/images/logic-apps-refresh-analysis-services/6.png" src=""/> 
</div>  </li>
<li>Search for <strong>Control</strong>

<div class="lazy" style="max-height: 272px">
    <div style="padding-bottom:41.08761329305136%"></div>
    <img data-src="/images/logic-apps-refresh-analysis-services/17.png" src=""/> 
</div>  </li>
<li>Add <strong>Until</strong> action

<div class="lazy" style="max-height: 49px">
    <div style="padding-bottom:26.344086021505376%"></div>
    <img data-src="/images/logic-apps-refresh-analysis-services/18.png" src=""/> 
</div>  </li>
<li>Configure until loop condition to <strong>refreshStatus</strong> is not equal to <strong>succeeded</strong>

<div class="lazy" style="max-height: 266px">
    <div style="padding-bottom:39.407407407407405%"></div>
    <img data-src="/images/logic-apps-refresh-analysis-services/19.png" src=""/> 
</div>  </li>
<li>In order to handle <strong>failed</strong> status an advanced editor must be used with following formula.

<div class="lazy" style="max-height: 170px">
    <div style="padding-bottom:24.285714285714285%"></div>
    <img data-src="/images/logic-apps-refresh-analysis-services/20.png" src=""/> 
</div>  
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"> <span class="err">@or(equals(variables(&#39;refreshStatus&#39;),</span> <span class="err">&#39;succeeded&#39;),</span> <span class="err">equals(variables(&#39;refreshStatus&#39;),</span> <span class="err">&#39;failed&#39;))</span>
 </code></pre></div></li>
<li>Add new step

<div class="lazy" style="max-height: 39px">
    <div style="padding-bottom:29.545454545454547%"></div>
    <img data-src="/images/logic-apps-refresh-analysis-services/6.png" src=""/> 
</div>  </li>
<li>Search for <strong>Schedule</strong> action group and select <strong>Delay</strong> action

<div class="lazy" style="max-height: 283px">
    <div style="padding-bottom:46.39344262295082%"></div>
    <img data-src="/images/logic-apps-refresh-analysis-services/42.png" src=""/> 
</div>  </li>
<li>Set it to 30 seconds, fine tune this setting later on.

<div class="lazy" style="max-height: 177px">
    <div style="padding-bottom:28.229665071770334%"></div>
    <img data-src="/images/logic-apps-refresh-analysis-services/40.png" src=""/> 
</div>  </li>
<li>Optionally fine tune until loop limits.

<div class="lazy" style="max-height: 300px">
    <div style="padding-bottom:45.31722054380665%"></div>
    <img data-src="/images/logic-apps-refresh-analysis-services/41.png" src=""/> 
</div>  </li>
<li>Click on <strong>add an action</strong> button and add new HTTP step

<div class="lazy" style="max-height: 570px">
    <div style="padding-bottom:51.2589928057554%"></div>
    <img data-src="/images/logic-apps-refresh-analysis-services/21.png" src=""/> 
</div>  

<ul>
<li><strong>Method</strong> - getting status of refresh is done using <strong>GET</strong> method</li>
<li><strong>URI</strong> is build as https://<strong>&lt;rollout&gt;</strong>.asazure.windows.net/servers/<strong>&lt;serverName&gt;</strong>/models/<strong>&lt;resource&gt;</strong>/refreshes/<strong>&lt;refresh_id&gt;</strong>

<div class="lazy" style="max-height: 155px">
    <div style="padding-bottom:17.51412429378531%"></div>
    <img data-src="/images/logic-apps-refresh-analysis-services/aas-async-refresh-flow-get.png" src=""/> 
</div>  
HTTP call which submits refresh to analysis services return &ldquo;Location&rdquo; header. This header contains full URL with refresh ID which then can be used to check refresh status. This can be obtained using following logic app expression.
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="err">outputs(&#39;HTTP&#39;)</span><span class="p">[</span><span class="err">&#39;headers&#39;</span><span class="p">][</span><span class="err">&#39;location&#39;</span><span class="p">]</span></code></pre></div></li>
<li><strong>Authentication</strong> - Authenticate to Analysis Services using previously created application. This should be configured exactly the same as in the first call.</li>
</ul></li>
<li>Add new step

<div class="lazy" style="max-height: 39px">
    <div style="padding-bottom:29.545454545454547%"></div>
    <img data-src="/images/logic-apps-refresh-analysis-services/6.png" src=""/> 
</div>  </li>
<li>From <strong>Variables</strong> action group use <strong>Set variable</strong> action

<div class="lazy" style="max-height: 211px">
    <div style="padding-bottom:18.97482014388489%"></div>
    <img data-src="/images/logic-apps-refresh-analysis-services/22.png" src=""/> 
</div>  </li>
<li>Configure with expression which replaces current value with retrieved status using following expression
<div class="highlight"><pre class="chroma"><code class="language-json" data-lang="json"><span class="err">body(&#39;HTTP_</span><span class="mi">2</span><span class="err">&#39;)</span><span class="p">[</span><span class="err">&#39;status&#39;</span><span class="p">]</span></code></pre></div></li>
<li>Save Logic App and run it

<div class="lazy" style="max-height: 266px">
    <div style="padding-bottom:34.77124183006536%"></div>
    <img data-src="/images/logic-apps-refresh-analysis-services/13.png" src=""/> 
</div>  </li>
<li>Check the status

<div class="lazy" style="max-height: 86px">
    <div style="padding-bottom:7.818181818181818%"></div>
    <img data-src="/images/logic-apps-refresh-analysis-services/14.png" src=""/> 
</div>  </li>
<li>Review logic app run

<div class="lazy" style="max-height: 612px">
    <div style="padding-bottom:87.42857142857143%"></div>
    <img data-src="/images/logic-apps-refresh-analysis-services/43.png" src=""/> 
</div>  </li>
</ol>

<h3 id="final-thoughts">Final thoughts</h3>

<p>When going to production it would be advised to add <strong>until</strong> loop which will try to submit process refresh until available slot comes appears. This of course depends on the refresh type and if process is not very complex or there are no multiple separate orchestration flows, then this might simply not be required.</p>

<h2 id="summary">Summary</h2>

<p>A careful reader should by now understand and be able to execute following activities</p>

<ul>
<li>Understand basics of Azure Analysis Services refresh API</li>
<li>Set up an application account (service principal) and assigning administrative privileges to this account on Azure Analysis Services</li>
<li>Submit REST calls to Azure Management API and controlling Azure Analysis Services Refreshes</li>
<li>Orchestrate workflows using Logic Apps</li>
</ul>

<p>If you enjoyed this article you might want to check <a href="/posts/analysis-services-onprem-integration/">how to set up Analysis Services with On-premises gateway</a>.</p><a target="_blank" 
   rel="tooltip" 
   class="btn btn-github"
   href="https://github.com/MarczakIO/aas-refresh-logic-apps">
    <i class="fa fa-github"></i>
    Source Code
</a>
    </article>
    <div class="section-blog-info">
        <div class="row">
            <div class="col-md-12 text-center">
                <h3 class="text-center">Did you enjoy the article?</h3>
            </div>
            <div class="col-md-6 text-center">
                <h4 class="">Share it!</h4><a target="_blank" 
   rel="tooltip" 
   data-original-title="Share on Facebook" 
   class="btn btn-just-icon btn-share btn-facebook"
   href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fmarczak.io%2fposts%2f2019%2f06%2flogic-apps-refresh-analysis-services%2f">
    <i class="fa fa-facebook"></i>
</a>
<a target="_blank" 
   rel="tooltip" 
   data-original-title="Share on Twitter" 
   class="btn btn-just-icon btn-share btn-twitter" 
   href="https://twitter.com/home?status=Refreshing%20Azure%20Analysis%20Services%20models%20using%20Logic%20Apps - https%3a%2f%2fmarczak.io%2fposts%2f2019%2f06%2flogic-apps-refresh-analysis-services%2f">
   <i class="fa fa-twitter"></i>
</a>
<a target="_blank" 
   rel="tooltip" 
   data-original-title="Share on Google+" 
   class="btn btn-just-icon btn-share btn-google" 
   href="https://plus.google.com/share?url=https%3a%2f%2fmarczak.io%2fposts%2f2019%2f06%2flogic-apps-refresh-analysis-services%2f"><i 
   class="fa fa-google"></i>
</a>
            
            </div>
            <div class="col-md-6 text-center large">
                <h4 class="">More tagged posts</h4>
  <div class="tag-list">
    <a href="https://marczak.io/tags/analysis-services" title="View all posts in Analysis Services">
      <img src="https://marczak.io/images/tags//analysis-services.svg" alt="Analysis Services"/>
    </a>
    <a href="https://marczak.io/tags/azure" title="View all posts in Azure">
      <img src="https://marczak.io/images/tags//azure.svg" alt="Azure"/>
    </a>
    <a href="https://marczak.io/tags/logic-apps" title="View all posts in Logic Apps">
      <img src="https://marczak.io/images/tags//logic-apps.svg" alt="Logic Apps"/>
    </a>
  </div>
            </div>
        </div>
        <div class="row comments">
            <div class="col-md-12"><div id="disqus_thread"></div>
<script>
var disqus_config = function () {
this.page.url = "https:\/\/marczak.io\/posts\/2019\/06\/logic-apps-refresh-analysis-services\/"; 
this.page.identifier = "\/posts\/2019\/06\/logic-apps-refresh-analysis-services\/";
};

(function() {
if (window.location.hostname == "localhost")return;
var d = document, s = d.createElement('script');
s.src = 'https://marczak-io.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
            </div>
        </div> 
    </div>
</div>
            <div class="col-md-3 blog-sidebar-wrapper">
              <aside id="secondary" class="blog-sidebar" role="complementary"><div id="recent-posts" class="recent-posts widget widget_recent_entries">
<h5>Recent Posts</h5>
<ul>
        <li><b class="list-header">2019 June</b></li>
        <li class="indented">
            <a href="/posts/2019/06/logic-apps-refresh-analysis-services/" title="Refreshing Azure Analysis Services models using Logic Apps" rel="bookmark">
                <b>15th </b>Refreshing Azure Analysis Services models using Logic Apps
            </a>
        </li>
        <li><b class="list-header">2018 June</b></li>
        <li class="indented">
            <a href="/posts/analysis-services-onprem-integration/" title="Azure Analysis Services hybrid enrivonment with on-premises databases" rel="bookmark">
                <b>26th </b>Azure Analysis Services hybrid enrivonment with on-premises databases
            </a>
        </li>
        <li class="indented">
            <a href="/posts/azure-loading-csv-to-sql/" title="Quick, easy and cheap way to automate data loading from CSV file into Azure SQL" rel="bookmark">
                <b>3rd </b>Quick, easy and cheap way to automate data loading from CSV file into Azure SQL
            </a>
        </li>
        <li><b class="list-header">2018 March</b></li>
        <li class="indented">
            <a href="/posts/botseries-dev-done-easy/" title="Effective chatbot development with ngrok" rel="bookmark">
                <b>12th </b>Effective chatbot development with ngrok
            </a>
        </li>
        <li><b class="list-header">2018 February</b></li>
        <li class="indented">
            <a href="/posts/netcore-vuejs-crud/" title="Build CRUD operations in SPA using Vue.js, .NET Core 2.0 and Azure Cosmos DB" rel="bookmark">
                <b>17th </b>Build CRUD operations in SPA using Vue.js, .NET Core 2.0 and Azure Cosmos DB
            </a>
        </li>
</ul>
</div><div id="categories-3" class="widget widget_categories">
  <h5>Tags</h5>
  <ul class="tag-list">
      <li>
        <div class="lazy" style="width:30px;height:20px;float:left;">
          <img src="" data-src="https://marczak.io/images/tags//analysis-services.svg" alt="Analysis Services"/> 
        </div> 
        <a href="https://marczak.io/tags/analysis-services">Analysis Services (2)</a>
      </li>
      <li>
        <div class="lazy" style="width:30px;height:20px;float:left;">
          <img src="" data-src="https://marczak.io/images/tags//azure.svg" alt="Azure"/> 
        </div> 
        <a href="https://marczak.io/tags/azure">Azure (10)</a>
      </li>
      <li>
        <div class="lazy" style="width:30px;height:20px;float:left;">
          <img src="" data-src="https://marczak.io/images/tags//bot-service.svg" alt="Bot Service"/> 
        </div> 
        <a href="https://marczak.io/tags/bot-service">Bot Service (5)</a>
      </li>
      <li>
        <div class="lazy" style="width:30px;height:20px;float:left;">
          <img src="" data-src="https://marczak.io/images/tags//cognitive-services.svg" alt="Cognitive Services"/> 
        </div> 
        <a href="https://marczak.io/tags/cognitive-services">Cognitive Services (2)</a>
      </li>
      <li class="child"> 
        <img src="https://marczak.io/images/tags//luis.svg" alt="Luis"/>
        <a href="https://marczak.io/tags/luis">Luis (1)</a>
      </li>
      <li class="child"> 
        <img src="https://marczak.io/images/tags//text-analytics.svg" alt="Text Analytics"/>
        <a href="https://marczak.io/tags/text-analytics">Text Analytics (1)</a>
      </li>
      <li>
        <div class="lazy" style="width:30px;height:20px;float:left;">
          <img src="" data-src="https://marczak.io/images/tags//cosmos-db.svg" alt="Cosmos Db"/> 
        </div> 
        <a href="https://marczak.io/tags/cosmos-db">Cosmos Db (1)</a>
      </li>
      <li>
        <div class="lazy" style="width:30px;height:20px;float:left;">
          <img src="" data-src="https://marczak.io/images/tags//data-gateway.svg" alt="Data Gateway"/> 
        </div> 
        <a href="https://marczak.io/tags/data-gateway">Data Gateway (1)</a>
      </li>
      <li>
        <div class="lazy" style="width:30px;height:20px;float:left;">
          <img src="" data-src="https://marczak.io/images/tags//dotnet-core.svg" alt="Dotnet Core"/> 
        </div> 
        <a href="https://marczak.io/tags/dotnet-core">Dotnet Core (2)</a>
      </li>
      <li>
        <div class="lazy" style="width:30px;height:20px;float:left;">
          <img src="" data-src="https://marczak.io/images/tags//flow.svg" alt="Flow"/> 
        </div> 
        <a href="https://marczak.io/tags/flow">Flow (1)</a>
      </li>
      <li>
        <div class="lazy" style="width:30px;height:20px;float:left;">
          <img src="" data-src="https://marczak.io/images/tags//functions.svg" alt="Functions"/> 
        </div> 
        <a href="https://marczak.io/tags/functions">Functions (1)</a>
      </li>
      <li>
        <div class="lazy" style="width:30px;height:20px;float:left;">
          <img src="" data-src="https://marczak.io/images/tags//logic-apps.svg" alt="Logic Apps"/> 
        </div> 
        <a href="https://marczak.io/tags/logic-apps">Logic Apps (2)</a>
      </li>
      <li>
        <div class="lazy" style="width:30px;height:20px;float:left;">
          <img src="" data-src="https://marczak.io/images/tags//sql.svg" alt="Sql"/> 
        </div> 
        <a href="https://marczak.io/tags/sql">Sql (2)</a>
      </li>
      <li>
        <div class="lazy" style="width:30px;height:20px;float:left;">
          <img src="" data-src="https://marczak.io/images/tags//teams.svg" alt="Teams"/> 
        </div> 
        <a href="https://marczak.io/tags/teams">Teams (2)</a>
      </li>
      <li>
        <div class="lazy" style="width:30px;height:20px;float:left;">
          <img src="" data-src="https://marczak.io/images/tags//visual-studio.svg" alt="Visual Studio"/> 
        </div> 
        <a href="https://marczak.io/tags/visual-studio">Visual Studio (3)</a>
      </li>
      <li>
        <div class="lazy" style="width:30px;height:20px;float:left;">
          <img src="" data-src="https://marczak.io/images/tags//visual-studio-code.svg" alt="Visual Studio Code"/> 
        </div> 
        <a href="https://marczak.io/tags/visual-studio-code">Visual Studio Code (2)</a>
      </li>
      <li>
        <div class="lazy" style="width:30px;height:20px;float:left;">
          <img src="" data-src="https://marczak.io/images/tags//vue.js.svg" alt="Vue.js"/> 
        </div> 
        <a href="https://marczak.io/tags/vue.js">Vue.js (2)</a>
      </li>
      <li>
        <div class="lazy" style="width:30px;height:20px;float:left;">
          <img src="" data-src="https://marczak.io/images/tags//webpack.svg" alt="Webpack"/> 
        </div> 
        <a href="https://marczak.io/tags/webpack">Webpack (1)</a>
      </li>
  </ul>
</div>
              </aside>
            </div>
          </div>
        </div>
      </div>
<footer class="footer footer-black footer-big">
    <div class="container">
        <div class="row">
            <div class="col-md-12">
                <h5 class="connected-title">Stay Connected</h5>
                <div class="">
  <a target="_top" class="btn btn-just-icon btn-social-small btn-social-about"
     href="/about">
    <i class="fa fa-user"></i>
  </a>
  <a target="_top" class="btn btn-just-icon btn-social-small btn-social-mail"
     href="mailto:adam@marczak.io">
    <i class="fa fa-envelope"></i>
  </a>
  <a target="_blank" class="btn btn-just-icon btn-social-small btn-social-facebook"
     href="https://www.facebook.com/MarczakIO/">
    <i class="fa fa-facebook"></i>
  </a>
  <a target="_blank" class="btn btn-just-icon btn-social-small btn-social-twitter"
     href="https://twitter.com/MarczakIO">
    <i class="fa fa-twitter"></i>
  </a>
  <a target="_blank" class="btn btn-just-icon btn-social-small btn-social-github"
     href="https://github.com/MarczakIO">
    <i class="fa fa-github"></i>
  </a>
  <a target="_blank" class="btn btn-just-icon btn-social-small btn-social-youtube"
     href="https://www.youtube.com/channel/UCbbjOn2UosI_yaD5d4w_Flw">
    <i class="fa fa-youtube"></i>
  </a>
  <a target="_blank" class="btn btn-just-icon btn-social-small btn-social-linkedin"
     href="https://www.linkedin.com/in/adam-marczak-96088929/">
    <i class="fa fa-linkedin"></i>
  </a>
  <a target="_blank" class="btn btn-just-icon btn-social-small btn-social-rss"
     href="https://marczak.io/index.xml">
    <i class="fa fa-rss"></i>
  </a>
</div>
            </div>
            &copy;<a href="/about" title="Adam Marczak" class="vcard author"><strong class="fn">Adam Marczak</strong></a> <a href="https://themeisle.com/themes/hestia/" target="_blank" rel="nofollow">Hestia Theme</a>
        </div>
    </div>
</footer>
    </div>
  </div>
  
  <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  
  <script>window.jQuery || document.write('<script src="https:\/\/marczak.io\/js\/jquery.js"><\/script>')</script>
  
  <script src="https://netdna.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
  
  <script>if(typeof($.fn.modal) === 'undefined') {document.write('<script src="https:\/\/marczak.io\/js\/bootstrap.min.js"><\/script>')}</script>
  
  <div id="bootstrapCssTest" class="hidden"></div>
  <script>
    $(function() {
      if ($('#bootstrapCssTest').is(':visible')) {
        $("head").prepend('<link rel="stylesheet" href="https:\/\/marczak.io\/css\/bootstrap.min.css">');
      }
    });
  </script>
  <script type="text/javascript" src="https://marczak.io/js/main.min.js?ver=1.15"></script>
</body>
</html>